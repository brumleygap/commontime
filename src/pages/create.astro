
---
import BaseLayout from "../layouts/BaseLayout.astro";
import { actions } from "astro:actions";

const result = await Astro.getActionResult(actions.createPoll);

if (result?.data && result.data.ok) {
  return Astro.redirect(`/poll/${result.data.token}`);
}
---

<BaseLayout title="Create Poll">
  <section class="mx-auto max-w-3xl px-4 py-12">
    <h2 class="text-2xl font-bold text-slate-900">Create a poll</h2>
    <p class="mt-2 text-slate-600">Give it a name and choose possible dates and times.</p>

    {result?.error && (
      <div class="mt-6 rounded-md border border-red-300 bg-red-50 p-4 text-red-800">
        <p class="font-semibold">Fix these:</p>
        <pre class="mt-2 text-sm whitespace-pre-wrap">
{JSON.stringify(result.error, null, 2)}
        </pre>
      </div>
    )}

    <form method="POST" action={actions.createPoll} class="mt-8 space-y-6">
      <input type="hidden" name="timezone" value="America/New_York" />

      <div>
        <label for="title" class="block text-sm font-medium text-slate-700">Poll title</label>
        <input
          id="title"
          name="title"
          type="text"
          required
          class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500"
        />
      </div>

      <div>
        <label for="description" class="block text-sm font-medium text-slate-700">Description (optional)</label>
        <textarea
          id="description"
          name="description"
          rows="3"
          class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500"
        ></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700">Possible date & time options</label>

        <!-- Hidden field that will contain the array -->
        <input type="hidden" name="options" id="options-data" />

        <!-- Visible datetime inputs (NOT submitted directly) -->
        <input
          type="datetime-local"
          class="datetime-option mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500"
          required
        />

        <input
          type="datetime-local"
          class="datetime-option mt-2 block w-full rounded-md border-slate-300 shadow-sm focus:border-red-500 focus:ring-red-500"
          required
        />

        <p class="mt-2 text-xs text-slate-500">
          Enter the possible times. People choose availability on the next screen.
        </p>
      </div>

      <div class="flex justify-end gap-3">
        <a href="/" class="rounded-md border px-4 py-2 text-sm text-slate-700 hover:bg-slate-100">Cancel</a>
        <button type="submit" class="rounded-md bg-red-600 px-5 py-2 text-sm font-semibold text-white hover:bg-red-700">
          Create poll
        </button>
      </div>
    </form>
  </section>
</BaseLayout>

<script>
  // Collect all datetime values before form submission
  document.querySelector('form')?.addEventListener('submit', (e) => {
    const datetimes = Array.from(document.querySelectorAll('.datetime-option'))
      .map(input => (input as HTMLInputElement).value)
      .filter(Boolean);
    
    const hiddenField = document.getElementById('options-data') as HTMLInputElement;
    hiddenField.value = JSON.stringify(datetimes);
  });
</script>
